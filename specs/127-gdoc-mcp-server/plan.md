# Implementation Plan: Google Docs MCP Server

**Branch**: `127-gdoc-mcp-server` | **Date**: 2026-01-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/127-gdoc-mcp-server/spec.md`

## Summary

Wrap the existing GoogleDocsConverter functionality in an MCP (Model Context Protocol) server, exposing tools for section-level document editing, full-tab operations, and formatting normalization. The server uses the official MCP Python SDK with decorator-based tool definitions optimized for LLM discoverability. All content exchange uses MEBDF (Markdown Extensions for Basic Doc Formatting) to ensure round-trip safety.

## Technical Context

**Language/Version**: Python 3.11+ (matches existing project requirement)
**Primary Dependencies**: `mcp>=1.25.0` (official MCP SDK), existing `extended_google_doc_utils` (converter, auth)
**Storage**: N/A (stateless—credentials from file or environment per existing CredentialManager)
**Testing**: pytest with tier_a (real API) and tier_b (mocked) markers
**Target Platform**: Local development (macOS, Linux, Windows via stdio transport)
**Project Type**: Single project (extends existing codebase)
**Performance Goals**: Tool discovery <1s, hierarchy <3s, section ops <5s, formatting <30s (per SC-004-007)
**Constraints**: Must preserve section isolation (SC-002), round-trip fidelity (SC-003)
**Scale/Scope**: Single-user local server, documents up to 100 pages

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with Extended Google Doc Utils Constitution v1.0.0:

- [x] **I. LLM-Friendly Format Design**: Tool definitions use type hints, docstrings, and constrained parameters for optimal LLM comprehension. MEBDF format unchanged.
- [x] **II. Round-Trip Safety**: All operations use MEBDF through existing converter. Formatting operations transform MEBDF, preserving round-trip safety.
- [x] **III. Minimal Verbosity**: Tool responses are concise JSON. MEBDF format unchanged.
- [x] **IV. Backward Compatibility**: New feature adds MCP layer without changing converter API. Existing MEBDF documents remain compatible.
- [x] **V. Specification-Driven Development**: Full spec completed before planning. 26 functional requirements defined.

**Testing Standards**:
- [x] Contract tests planned: MCP tool schema validation, parameter constraints
- [x] Round-trip tests planned: Section export/import preservation (reuse existing converter tests)
- [x] LLM integration tests planned: Tool discovery and first-attempt accuracy validation
- [x] Edge case coverage identified: Permission errors, missing anchors, large documents, concurrent edits

## Project Structure

### Documentation (this feature)

```text
specs/127-gdoc-mcp-server/
├── plan.md              # This file
├── research.md          # MCP SDK selection and patterns
├── data-model.md        # Tool definitions and response schemas
├── quickstart.md        # Usage guide for MCP server
├── contracts/           # MCP tool JSON schemas
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── extended_google_doc_utils/
│   ├── auth/                    # Existing: CredentialManager, OAuth
│   ├── converter/               # Existing: GoogleDocsConverter, MEBDF
│   ├── google_api/              # Existing: docs_client, drive_client
│   ├── mcp/                     # NEW: MCP server module
│   │   ├── __init__.py
│   │   ├── server.py            # FastMCP server and tool registrations
│   │   ├── tools/               # Tool implementations by category
│   │   │   ├── __init__.py
│   │   │   ├── navigation.py    # list_documents, get_metadata, get_hierarchy
│   │   │   ├── sections.py      # export_section, import_section
│   │   │   ├── tabs.py          # export_tab, import_tab
│   │   │   └── formatting.py    # normalize_formatting, extract_styles, apply_styles
│   │   ├── schemas.py           # Response dataclasses for type safety
│   │   └── errors.py            # Structured error types
│   └── utils/                   # Existing: config, logging

tests/
├── mcp/                         # NEW: MCP-specific tests
│   ├── test_server.py           # Server lifecycle, tool discovery
│   ├── test_navigation_tools.py # Navigation tool contracts
│   ├── test_section_tools.py    # Section tool contracts
│   ├── test_tab_tools.py        # Tab tool contracts
│   └── test_formatting_tools.py # Formatting tool contracts
├── contract/                    # Existing
├── integration/                 # Existing
└── unit/                        # Existing
```

**Structure Decision**: Extend existing single-project structure with new `mcp/` module. Tools are organized by functional category (navigation, sections, tabs, formatting) to match the spec's requirement groupings and enable focused testing.

## Complexity Tracking

> No constitution violations identified. All design decisions align with core principles.

| Aspect | Decision | Justification |
|--------|----------|---------------|
| Tool organization | Separate modules per category | Matches spec FR groupings, enables focused testing |
| Formatting via MEBDF | Transform MEBDF rather than direct API | Preserves round-trip safety (Constitution II) |
| Single server instance | Reuse credentials/converter | Simpler than per-request initialization |
